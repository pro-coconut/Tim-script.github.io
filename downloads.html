<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý file tải</title>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:white}
.container{max-width:1000px;margin:30px auto;padding:20px}
.box{background:#0f172a;padding:16px;border-radius:12px;margin-bottom:20px}
input,textarea{width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #1f2a44;background:#0f1a28;color:white}
button{margin-top:10px;padding:10px 14px;border:0;border-radius:8px;background:#38bdf8;font-weight:700;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:14px}
.card{background:#1e293b;border-radius:10px;overflow:hidden}
.thumb{height:140px;background:#071826}
.thumb img{width:100%;height:100%;object-fit:cover}
.content{padding:10px}
.title{font-weight:700;margin-bottom:4px}
.actions{display:flex;gap:6px;margin-top:8px}
.progress{height:20px;background:#1f2a44;border-radius:8px;overflow:hidden;margin-top:8px}
.bar{height:100%;width:0%;background:#22c55e;text-align:center;font-size:12px}
#status{margin-top:8px;color:#facc15;font-size:13px;white-space:pre-wrap}
</style>
</head>

<body>
<div class="container">

<div class="box">
<h3>Upload file mới</h3>
<input id="token" placeholder="GitHub Token">
<input id="name" placeholder="Tên file">
<textarea id="desc" placeholder="Mô tả"></textarea>

<input type="file" id="thumb" accept="image/*">
<img id="preview" style="max-width:150px;margin-top:8px;display:none;border-radius:8px">

<input type="file" id="file">
<button onclick="upload()">Upload</button>

<div class="progress"><div id="bar" class="bar">0%</div></div>
<div id="status"></div>
</div>

<h3>Danh sách file đã upload</h3>
<div id="list" class="grid"></div>

</div>

<script>
const REPO = "pro-coconut/Tim-script.github.io";
const BRANCH = "main";

const tokenEl=token,nameEl=name,descEl=desc,thumbEl=thumb,fileEl=file,barEl=bar,statusEl=status,listEl=list;

thumbEl.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{preview.src=r.result;preview.style.display="block";}
  r.readAsDataURL(e.target.files[0]);
}

function setStatus(t){statusEl.innerText=t}
function progress(p){barEl.style.width=p+"%";barEl.innerText=p+"%"}

function b64(file){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result.split(',')[1]);
    fr.readAsDataURL(file);
  });
}

async function ghFetch(url,options){
  const res = await fetch(url,{
    ...options,
    headers:{
      ...(options.headers||{}),
      Authorization:"Bearer "+tokenEl.value.trim(),
      Accept:"application/vnd.github+json"
    }
  });
  const text = await res.text();
  if(!res.ok){
    throw new Error(text);
  }
  return text ? JSON.parse(text) : {};
}

async function putFile(path,content){
  await ghFetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    method:"PUT",
    body:JSON.stringify({message:"upload "+path,content})
  });
}

async function getData(){
  const res=await fetch(`https://raw.githubusercontent.com/${REPO}/${BRANCH}/data.json`);
  return await res.json();
}

async function updateData(item){
  const j = await ghFetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{});
  const data = JSON.parse(atob(j.content));
  data.unshift(item);

  await ghFetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    method:"PUT",
    body:JSON.stringify({
      message:"update data",
      content:btoa(JSON.stringify(data,null,2)),
      sha:j.sha
    })
  });
}

async function upload(){
  try{
    progress(5);
    setStatus("Đang kiểm tra dữ liệu...");

    if(!tokenEl.value||!nameEl.value||!thumbEl.files[0]||!fileEl.files[0]){
      throw new Error("Thiếu dữ liệu nhập vào");
    }

    const t=Date.now();
    const thumbPath=`thumbs/${t}_${thumbEl.files[0].name}`;
    const filePath=`files/${t}_${fileEl.files[0].name}`;

    progress(15);
    setStatus("Upload thumbnail...");
    await putFile(thumbPath,await b64(thumbEl.files[0]));

    progress(45);
    setStatus("Upload file...");
    await putFile(filePath,await b64(fileEl.files[0]));

    progress(75);
    setStatus("Cập nhật data.json...");
    await updateData({name:nameEl.value,desc:descEl.value,thumb:thumbPath,file:filePath});

    progress(100);
    setStatus("✅ Upload thành công!");
    loadList();
  }
  catch(e){
    setStatus("❌ LỖI:\n"+e.message);
  }
}

async function deleteFile(path){
  const j = await ghFetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{});
  await ghFetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    method:"DELETE",
    body:JSON.stringify({message:"delete "+path,sha:j.sha})
  });
}

async function del(i){
  try{
    setStatus("Đang xóa...");
    const data=await getData();
    const item=data[i];

    await deleteFile(item.thumb);
    await deleteFile(item.file);

    data.splice(i,1);

    const j = await ghFetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{});
    await ghFetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
      method:"PUT",
      body:JSON.stringify({
        message:"delete item",
        content:btoa(JSON.stringify(data,null,2)),
        sha:j.sha
      })
    });

    setStatus("✅ Đã xóa");
    loadList();
  }catch(e){
    setStatus("❌ Lỗi xóa:\n"+e.message);
  }
}

async function loadList(){
  const data=await getData();
  listEl.innerHTML=data.map((d,i)=>`
    <div class="card">
      <div class="thumb">
        <img src="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${d.thumb}">
      </div>
      <div class="content">
        <div class="title">${d.name}</div>
        <div>${d.desc}</div>
        <div class="actions">
          <a href="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${d.file}" download><button>Tải</button></a>
          <button onclick="del(${i})">Xóa</button>
        </div>
      </div>
    </div>
  `).join('');
}

loadList();
</script>
</body>
</html>
