<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý file tải</title>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:white}
.container{max-width:1000px;margin:30px auto;padding:20px}
.box{background:#0f172a;padding:16px;border-radius:12px;margin-bottom:20px}
input,textarea{width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #1f2a44;background:#0f1a28;color:white}
button{margin-top:10px;padding:10px 14px;border:0;border-radius:8px;background:#38bdf8;font-weight:700;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:14px}
.card{background:#1e293b;border-radius:10px;overflow:hidden}
.thumb{height:140px;background:#071826}
.thumb img{width:100%;height:100%;object-fit:cover}
.content{padding:10px}
.title{font-weight:700;margin-bottom:4px}
.actions{display:flex;gap:6px;margin-top:8px}
.progress{height:22px;background:#1f2a44;border-radius:8px;overflow:hidden;margin-top:10px}
.bar{height:100%;width:0%;background:#22c55e;text-align:center;font-size:12px}
</style>
</head>

<body>
<div class="container">

<div class="box">
<h3>Upload file mới</h3>

<input id="token" placeholder="GitHub Token">
<input id="name" placeholder="Tên file">
<textarea id="desc" placeholder="Mô tả"></textarea>

<input type="file" id="thumb" accept="image/*">
<img id="preview" style="max-width:150px;margin-top:8px;display:none;border-radius:8px">

<input type="file" id="file">

<button onclick="upload()">Upload</button>

<div class="progress"><div id="bar" class="bar">0%</div></div>
<div id="status"></div>
</div>

<h3>Danh sách file đã upload</h3>
<div id="list" class="grid"></div>

</div>

<script>
const REPO = "pro-coconut/tim-script.github.io";
const BRANCH = "main";

let thumbFile = null;
let mainFile = null;

// FIX ANDROID: lưu file ngay khi chọn
thumb.onchange = e=>{
  thumbFile = e.target.files[0];
  const r=new FileReader();
  r.onload=()=>{preview.src=r.result;preview.style.display="block";}
  r.readAsDataURL(thumbFile);
};

file.onchange = e=>{
  mainFile = e.target.files[0];
};

function b64(file){
  return new Promise(r=>{
    const fr=new FileReader();
    fr.onload=()=>r(fr.result.split(',')[1]);
    fr.readAsDataURL(file);
  });
}

function setBar(p){
  bar.style.width=p+"%";
  bar.innerText=p+"%";
}

async function upload(){
  const token=tokenEl.value.trim();
  const name=nameEl.value.trim();
  const desc=descEl.value.trim();

  if(!token||!name||!thumbFile||!mainFile){
    alert("Thiếu dữ liệu");
    return;
  }

  setBar(10);
  status.innerText="Upload thumbnail...";

  const t=Date.now();
  const thumbPath=`thumbs/${t}_${thumbFile.name}`;
  const filePath=`files/${t}_${mainFile.name}`;

  await putFile(thumbPath,await b64(thumbFile),token);

  setBar(50);
  status.innerText="Upload file...";

  await putFile(filePath,await b64(mainFile),token);

  setBar(80);
  status.innerText="Cập nhật data...";

  await updateData({name,desc,thumb:thumbPath,file:filePath},token);

  setBar(100);
  status.innerText="✅ Thành công!";
  loadList();
}

async function putFile(path,content,token){
  await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    method:"PUT",
    headers:{Authorization:"token "+token},
    body:JSON.stringify({message:"upload",content})
  });
}

async function getData(){
  const res=await fetch(`https://raw.githubusercontent.com/${REPO}/${BRANCH}/data.json`);
  return await res.json();
}

async function updateData(item,token){
  const res=await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    headers:{Authorization:"token "+token}
  });
  const j=await res.json();
  const data=JSON.parse(atob(j.content));
  data.unshift(item);

  await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    method:"PUT",
    headers:{Authorization:"token "+token},
    body:JSON.stringify({
      message:"update",
      content:btoa(JSON.stringify(data,null,2)),
      sha:j.sha
    })
  });
}

async function loadList(){
  const data=await getData();
  list.innerHTML=data.map((d,i)=>`
    <div class="card">
      <div class="thumb">
        <img src="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${d.thumb}">
      </div>
      <div class="content">
        <div class="title">${d.name}</div>
        <div>${d.desc}</div>
        <div class="actions">
          <a href="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${d.file}" download><button>Tải</button></a>
          <button onclick="del(${i})">Xóa</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function del(i){
  const token=tokenEl.value.trim();
  if(!token) return alert("Nhập token để xóa");

  const data=await getData();
  const item=data[i];

  await deleteFile(item.thumb,token);
  await deleteFile(item.file,token);

  data.splice(i,1);

  const res=await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    headers:{Authorization:"token "+token}
  });
  const j=await res.json();

  await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    method:"PUT",
    headers:{Authorization:"token "+token},
    body:JSON.stringify({
      message:"delete",
      content:btoa(JSON.stringify(data,null,2)),
      sha:j.sha
    })
  });

  loadList();
}

async function deleteFile(path,token){
  const res=await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    headers:{Authorization:"token "+token}
  });
  const j=await res.json();
  await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`,{
    method:"DELETE",
    headers:{Authorization:"token "+token},
    body:JSON.stringify({message:"delete",sha:j.sha})
  });
}

const tokenEl=token,nameEl=name,descEl=desc,bar=bar,status=status,list=list;
loadList();
</script>
</body>
</html>
