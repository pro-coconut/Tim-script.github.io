<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quản lý file tải</title>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:white}
.container{max-width:1000px;margin:30px auto;padding:20px}
.box{background:#0f172a;padding:16px;border-radius:12px;margin-bottom:20px}
input,textarea{width:100%;margin-top:8px;padding:10px;border-radius:8px;border:1px solid #1f2a44;background:#0f1a28;color:white}
button{margin-top:10px;padding:10px 14px;border:0;border-radius:8px;background:#38bdf8;font-weight:700;cursor:pointer}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:14px}
.card{background:#1e293b;border-radius:10px;overflow:hidden}
.thumb{height:140px;background:#071826}
.thumb img{width:100%;height:100%;object-fit:cover}
.content{padding:10px}
.title{font-weight:700;margin-bottom:4px}
.actions{display:flex;gap:6px;margin-top:8px}
.progress{height:20px;background:#1f2a44;border-radius:8px;overflow:hidden;margin-top:8px}
.bar{height:100%;width:0%;background:#22c55e;text-align:center;font-size:12px}
</style>
</head>

<body>
<div class="container">

<div class="box">
<h3>Upload file mới (siêu ổn định)</h3>
<input id="token" placeholder="GitHub Token (repo scope)">
<input id="name" placeholder="Tên file">
<textarea id="desc" placeholder="Mô tả"></textarea>
<input type="file" id="thumb" accept="image/*">
<input type="file" id="file">
<button onclick="upload()">Upload</button>

<div class="progress"><div id="bar" class="bar">0%</div></div>
<div id="status"></div>
</div>

<h3>Danh sách file</h3>
<div id="list" class="grid"></div>

</div>

<script>
const REPO = "pro-coconut/Tim-script.github.io";
const RELEASE_TAG = "files";

const tokenEl = document.getElementById("token");
const nameEl = document.getElementById("name");
const descEl = document.getElementById("desc");
const thumbEl = document.getElementById("thumb");
const fileEl = document.getElementById("file");
const bar = document.getElementById("bar");
const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");

function setProgress(p){
  bar.style.width = p + "%";
  bar.innerText = p + "%";
}

async function getReleaseId(token){
  const r = await fetch(`https://api.github.com/repos/${REPO}/releases/tags/${RELEASE_TAG}`,{
    headers:{Authorization:"token "+token}
  });
  const j = await r.json();
  return j.id;
}

function uploadAsset(url, file, token){
  return new Promise((resolve,reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Authorization","token "+token);
    xhr.setRequestHeader("Content-Type","application/octet-stream");

    xhr.upload.onprogress = e=>{
      if(e.lengthComputable){
        setProgress(Math.floor((e.loaded/e.total)*100));
      }
    };

    xhr.onload = ()=> resolve(JSON.parse(xhr.responseText));
    xhr.onerror = reject;

    xhr.send(file);
  });
}

async function upload(){
  try{
    const token = tokenEl.value.trim();
    const name = nameEl.value.trim();
    const desc = descEl.value.trim();
    const thumb = thumbEl.files[0];
    const file = fileEl.files[0];

    if(!token||!name||!thumb||!file) return alert("Thiếu dữ liệu");

    statusEl.innerText="Lấy release...";
    const releaseId = await getReleaseId(token);

    statusEl.innerText="Upload thumbnail...";
    setProgress(0);
    const thumbRes = await uploadAsset(
      `https://uploads.github.com/repos/${REPO}/releases/${releaseId}/assets?name=${Date.now()}_${thumb.name}`,
      thumb, token
    );

    statusEl.innerText="Upload file chính...";
    setProgress(0);
    const fileRes = await uploadAsset(
      `https://uploads.github.com/repos/${REPO}/releases/${releaseId}/assets?name=${Date.now()}_${file.name}`,
      file, token
    );

    statusEl.innerText="Cập nhật data.json...";
    await updateData({
      name,desc,
      thumb:thumbRes.browser_download_url,
      file:fileRes.browser_download_url
    }, token);

    statusEl.innerText="✅ Hoàn tất!";
    loadList();
  }catch(e){
    statusEl.innerText="❌ "+e;
  }
}

async function getData(){
  const r = await fetch(`https://raw.githubusercontent.com/${REPO}/main/data.json`);
  return await r.json();
}

async function updateData(item,token){
  const res=await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    headers:{Authorization:"token "+token}
  });
  const j=await res.json();
  const data=JSON.parse(atob(j.content));
  data.unshift(item);

  await fetch(`https://api.github.com/repos/${REPO}/contents/data.json`,{
    method:"PUT",
    headers:{Authorization:"token "+token},
    body:JSON.stringify({
      message:"update",
      content:btoa(JSON.stringify(data,null,2)),
      sha:j.sha
    })
  });
}

async function loadList(){
  const data=await getData();
  listEl.innerHTML=data.map(d=>`
    <div class="card">
      <div class="thumb">
        <img src="${d.thumb}">
      </div>
      <div class="content">
        <div class="title">${d.name}</div>
        <div>${d.desc}</div>
        <div class="actions">
          <a href="${d.file}"><button>Tải</button></a>
        </div>
      </div>
    </div>
  `).join('');
}

loadList();
</script>
</body>
</html>
