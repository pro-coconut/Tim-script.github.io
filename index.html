<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>T√¨m Script</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0b1220;color:#e6eef8}

header{
  padding:12px;
  background:#0f172a;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}

.logo{color:#38bdf8;font-weight:bold}

.search-wrap{
  flex:1;
  display:flex;
  gap:8px;
}

input{
  flex:1;
  padding:12px;
  border-radius:8px;
  border:0;
  font-size:16px;
  direction:ltr;
  text-align:left;
  background:#0f1a28;
  color:white;
}

button{
  border:0;
  border-radius:8px;
  padding:10px 12px;
  cursor:pointer;
  background:#38bdf8;
}

.container{padding:12px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:12px;
}

.card{
  background:#1e293b;
  border-radius:10px;
  overflow:hidden;
  cursor:pointer;
}

.thumb{
  height:150px;
  background:#071826;
}

.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}

.content{padding:10px}
.title{font-weight:bold;margin-bottom:6px}
.meta{color:#94a3b8;font-size:13px}
.loader{text-align:center;padding:20px;color:#94a3b8}
h2{color:#38bdf8}
</style>
</head>

<body>

<header>
  <div class="logo">t√¨m script c·ªßa t√¢m dz</div>

  <div class="search-wrap">
    <input id="inputSearch" placeholder="T√¨m script (blox fruit, admin...)" />
    <button onclick="startSearch()">T√¨m</button>
  </div>
</header>

<div class="container">

  <h2>üîé K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
  <div id="results" class="grid"></div>

  <h2>üÜï Script m·ªõi nh·∫•t</h2>
  <div id="latest" class="grid"></div>

</div>

<script>
const API = 'https://scriptblox.com/api/script/search';

/* -------- THUMBNAIL API M·ªöI -------- */
async function fetchThumbMap(ids){
  if(!ids.length) return {};
  const url = `https://thumbnails.roblox.com/v1/games/icons?universeIds=${ids.join(',')}&size=512x512&format=Png`;
  try{
    const res = await fetch(url);
    const j = await res.json();
    const map = {};
    (j.data||[]).forEach(d=> map[d.targetId]=d.imageUrl);
    return map;
  }catch{
    return {};
  }
}

function cardHTML(s, thumb){
  return `
  <div class="card" onclick="openView('${s._id}')">
    <div class="thumb">
      ${thumb ? `<img src="${thumb}">` : ``}
    </div>
    <div class="content">
      <div class="title">${s.title}</div>
      <div class="meta">${s.game?.name||'-'}</div>
      <div class="meta">üëÅ ${s.views||0}</div>
    </div>
  </div>`;
}

async function render(list, el){
  if(!list.length){
    el.innerHTML='<div class="loader">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
    return;
  }

  /* ---- FIX QUAN TR·ªåNG: gameId ---- */
  const ids = list.map(s=>s.game?.gameId).filter(Boolean);
  const thumbs = await fetchThumbMap(ids);

  el.innerHTML = list.map(s=>cardHTML(s, thumbs[s.game?.gameId])).join('');
}

async function loadLatest(){
  const res = await fetch(API+'?q=script&max=12');
  const j = await res.json();
  render(j.result.scripts, document.getElementById('latest'));
}

async function startSearch(){
  const q = document.getElementById('inputSearch').value.trim();
  if(!q) return;

  const res = await fetch(API+`?q=${encodeURIComponent(q)}&max=20`);
  const j = await res.json();
  render(j.result.scripts, document.getElementById('results'));
}

function openView(id){
  location.href = `view.html?id=${id}`;
}

document.getElementById('inputSearch')
  .addEventListener('keydown',e=>{ if(e.key==='Enter') startSearch(); });

loadLatest();
</script>

</body>
</html>
