<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ScriptBlox Mini ‚Äî Home</title>
<style>
  *{box-sizing:border-box}
  :root{
    --bg:#0b1220; --panel:#0f172a; --muted:#94a3b8; --accent:#38bdf8;
    --card:#1e293b; --radius:10px;
    font-family:Inter,Arial,Helvetica;
  }
  body{margin:0;background:var(--bg);color:#e6eef8}
  header{display:flex;gap:12px;align-items:center;padding:12px 16px;background:var(--panel);border-bottom:1px solid #172033}
  .logo{font-weight:700;color:var(--accent);font-size:18px}
  .search-wrap{flex:1;display:flex;gap:8px;align-items:center}
  input[type="search"]{width:100%;padding:10px 12px;border-radius:8px;border:0;background:#0f1a28;color:#e6eef8}
  .btn{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;cursor:pointer;color:#04293a}
  .small{padding:6px 8px;font-size:13px;border-radius:8px;border:0;cursor:pointer}
  .filters{display:flex;gap:8px;align-items:center}
  .container{max-width:1100px;margin:18px auto;padding:0 12px}
  .panel{background:var(--panel);padding:12px;border-radius:10px;margin-bottom:12px}
  h2{color:var(--accent);margin:8px 0}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
  .card{background:var(--card);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:transform .18s}
  .card:hover{transform:translateY(-6px)}
  .thumb{height:140px;background:#071826;display:flex;align-items:center;justify-content:center}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .content{padding:10px}
  .title{font-weight:700;margin-bottom:6px}
  .meta{color:var(--muted);font-size:13px;margin-bottom:6px}
  .pager{text-align:center;margin-top:16px}
  .pager button{margin:4px;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);cursor:pointer;color:#04293a}
  .muted{color:var(--muted)}
  .loader{text-align:center;padding:24px;color:var(--muted)}
  @media (max-width:520px){
    .logo{font-size:16px}
    .thumb{height:120px}
  }
</style>
</head>
<body>

<header>
  <div class="logo">ScriptBlox Mini</div>

  <div class="search-wrap">
    <input id="inputSearch" type="search" placeholder="T√¨m script (v√≠ d·ª•: blox fruit, admin)..." />
    <button id="btnSearch" class="btn">T√¨m</button>
    <button id="btnHistory" class="small">üìú</button>
  </div>

  <div class="filters">
    <button id="btnHome" class="small">Home</button>
    <button id="btnVerified" class="small">Verified</button>
    <button id="btnTrending" class="small">Trending</button>
  </div>
</header>

<main class="container">
  <section class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="muted" id="searchInfo">Trang ch·ªß ‚Äî xem script m·ªõi c·∫≠p nh·∫≠t</div>
      <div>
        <select id="selectMax" class="small">
          <option value="10">10 / trang</option>
          <option value="20">20 / trang (max)</option>
        </select>
        <button id="btnClearCache" class="small">X√≥a cache</button>
      </div>
    </div>
  </section>

  <section class="panel">
    <h2>üÜï Script m·ªõi nh·∫•t</h2>
    <div id="latest" class="grid"></div>
  </section>

  <section class="panel">
    <h2>üîé K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
    <div id="results" class="grid"></div>
    <div id="pager" class="pager"></div>
  </section>

  <div style="text-align:center;color:var(--muted);margin-top:12px">Powered by ScriptBlox ‚Ä¢ ScriptBlox Mini</div>
</main>

<script>
/* ---------- Config ---------- */
const API_BASE = 'https://scriptblox.com/api';
const SEARCH_ENDPOINT = API_BASE + '/script/search';
const THUMB_ENDPOINT = 'https://thumbnails.roblox.com/v1/places/gameicons';
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

/* ---------- Utils ---------- */
const qs = sel => document.querySelector(sel);
const qsa = sel => Array.from(document.querySelectorAll(sel));
function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function saveCache(key, data){ localStorage.setItem('cache:'+key, JSON.stringify({ts:Date.now(),data})); }
function readCache(key){
  try{
    const raw = localStorage.getItem('cache:'+key); if(!raw) return null;
    const obj = JSON.parse(raw); if(Date.now()-obj.ts > CACHE_TTL) { localStorage.removeItem('cache:'+key); return null; }
    return obj.data;
  }catch{return null;}
}
function clearAllCache(){ Object.keys(localStorage).forEach(k => { if(k.startsWith('cache:')) localStorage.removeItem(k); }); alert('Cache ƒë√£ x√≥a'); }

/* ---------- DOM Refs ---------- */
const inputEl = qs('#inputSearch');
const btnSearch = qs('#btnSearch');
const btnHistory = qs('#btnHistory');
const btnHome = qs('#btnHome');
const btnVerified = qs('#btnVerified');
const btnTrending = qs('#btnTrending');
const resultsEl = qs('#results');
const latestEl = qs('#latest');
const pagerEl = qs('#pager');
const searchInfo = qs('#searchInfo');
const selectMax = qs('#selectMax');
const btnClearCache = qs('#btnClearCache');

/* ---------- State ---------- */
let currentQuery = '';
let currentPage = 1;
let currentMax = parseInt(selectMax.value) || 10;
let currentMode = 'home'; // 'home'|'search'|'verified'|'trending'
let debounceTimer = null;

/* ---------- Thumbnail batching ---------- */
async function fetchThumbMap(placeIds){
  // placeIds: array of strings (unique)
  if(!placeIds || placeIds.length===0) return {};
  const unique = Array.from(new Set(placeIds));
  const map = {};
  const CHUNK = 20;
  for(let i=0;i<unique.length;i+=CHUNK){
    const ids = unique.slice(i,i+CHUNK).join(',');
    try{
      const res = await fetch(`${THUMB_ENDPOINT}?placeIds=${ids}&size=512x512&format=Png`);
      if(!res.ok) continue;
      const j = await res.json();
      (j.data||[]).forEach(d => { if(d && d.targetId) map[d.targetId] = d.imageUrl || ''; });
    }catch(e){
      // ignore per-chunk errors
    }
  }
  return map;
}

/* ---------- Render helpers ---------- */
function createCardHTML(s, thumbUrl){
  return `
    <div class="card" data-id="${escapeHtml(s._id)}">
      <div class="thumb">${ thumbUrl ? `<img loading="lazy" src="${thumbUrl}" alt="${escapeHtml(s.game?.name||'')}" />` : '<div style="padding:20px;color:var(--muted)">No Image</div>' }</div>
      <div class="content">
        <div class="title">${escapeHtml(s.title)}</div>
        <div class="meta">${escapeHtml(s.game?.name || '-')}</div>
        <div class="meta">T√°c gi·∫£: ${escapeHtml(s.owner?.username || '-') } ¬∑ üëÅ ${s.views || 0}</div>
      </div>
    </div>
  `;
}

function attachCardClicks(container){
  container.querySelectorAll('.card').forEach(card=>{
    card.onclick = ()=>{ const id = card.dataset.id; if(id) window.location.href = `view.html?id=${id}`; };
  });
}

/* ---------- Fetch/search flow ---------- */
async function apiSearch(q,page=1,max=10, filter=''){
  const key = `search:${q}:${page}:${max}:${filter}`;
  const cached = readCache(key);
  if(cached) return cached;
  const url = new URL(SEARCH_ENDPOINT);
  url.searchParams.set('q', q || '');
  url.searchParams.set('page', page);
  url.searchParams.set('max', max);
  if(filter) url.searchParams.set(filter,'true');
  // try to get newest scripts when home: use sortBy if supported (best-effort)
  if(currentMode === 'home') { url.searchParams.set('sortBy','createdAt'); url.searchParams.set('order','desc'); }
  try{
    const res = await fetch(url.toString());
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    saveCache(key, j);
    return j;
  }catch(err){
    // if API fails, return a friendly object
    return { error: err.message || 'L·ªói API' };
  }
}

/* ---------- Rendering lists (batch thumbnails) ---------- */
async function renderScriptsList(scripts, container){
  if(!scripts || scripts.length===0){
    container.innerHTML = '<div class="loader">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
    return;
  }
  // collect placeIds
  const placeIds = scripts.map(s => s.game?.placeId).filter(Boolean);
  const thumbMap = await fetchThumbMap(placeIds);
  // build HTML
  const html = scripts.map(s => createCardHTML(s, thumbMap[s.game?.placeId] || '')).join('');
  container.innerHTML = html;
  attachCardClicks(container);
}

/* ---------- UI flows ---------- */
async function loadLatest(){
  searchInfo.textContent = 'ƒêang t·∫£i script m·ªõi...';
  latestEl.innerHTML = '<div class="loader">ƒêang t·∫£i...</div>';
  const j = await apiSearch('', 1, 12, '');
  if(j.error){ latestEl.innerHTML = `<div class="loader">L·ªói: ${escapeHtml(j.error)}</div>`; return; }
  const scripts = j.result?.scripts || [];
  await renderScriptsList(scripts, latestEl);
  searchInfo.textContent = 'Trang ch·ªß ‚Äî script m·ªõi nh·∫•t';
}

async function loadPage(){
  // determine params
  let q = '';
  let filter = '';
  if(currentMode === 'search'){ q = currentQuery; filter = ''; }
  if(currentMode === 'verified'){ q = ''; filter = 'verified'; }
  if(currentMode === 'trending'){ q = 'blox'; filter = ''; } // fallback trending query
  searchInfo.textContent = `ƒêang t√¨m: "${q||'(m·∫∑c ƒë·ªãnh)'}" ¬∑ Trang ${currentPage}`;
  resultsEl.innerHTML = '<div class="loader">ƒêang t√¨m...</div>';
  pagerEl.innerHTML = '';

  const j = await apiSearch(q, currentPage, currentMax, filter);
  if(j.error){ resultsEl.innerHTML = `<div class="loader">L·ªói khi g·ªçi API: ${escapeHtml(j.error)}</div>`; return; }
  const scripts = j.result?.scripts || [];
  const totalPages = j.result?.totalPages || 1;
  await renderScriptsList(scripts, resultsEl);
  renderPager(totalPages);
  // save search history locally
  if(currentMode === 'search' && currentQuery) saveSearchHistory(currentQuery);
}

function renderPager(totalPages){
  if(!totalPages || totalPages <= 1){ pagerEl.innerHTML = ''; return; }
  const prevDisabled = currentPage <= 1;
  const nextDisabled = currentPage >= totalPages;
  pagerEl.innerHTML = `
    <button ${prevDisabled ? 'disabled' : ''} onclick="changePage(${currentPage-1})">‚Äπ Prev</button>
    <span style="margin:0 10px">Trang ${currentPage} / ${totalPages}</span>
    <button ${nextDisabled ? 'disabled' : ''} onclick="changePage(${currentPage+1})">Next ‚Ä∫</button>
  `;
}

function changePage(p){
  if(p < 1) return;
  currentPage = p;
  loadPage();
}

/* ---------- Search history (local trending) ---------- */
function saveSearchHistory(q){
  if(!q) return;
  const key = 'sb_history_v1';
  let hist = JSON.parse(localStorage.getItem(key) || '[]');
  const idx = hist.findIndex(h => h.q === q);
  if(idx >= 0){ hist[idx].count = (hist[idx].count||0) + 1; hist[idx].ts = Date.now(); }
  else hist.unshift({ q, count: 1, ts: Date.now() });
  hist = hist.slice(0, 50);
  localStorage.setItem(key, JSON.stringify(hist));
}
function showHistoryPrompt(){
  const key = 'sb_history_v1';
  const hist = JSON.parse(localStorage.getItem(key) || '[]');
  if(!hist.length) return alert('Ch∆∞a c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm');
  const text = hist.map(h => `${h.q} (${h.count})`).join('\n');
  const pick = prompt('L·ªãch s·ª≠ t√¨m ki·∫øm:\n' + text);
  if(pick){ inputEl.value = pick; startSearch(pick); }
}

/* ---------- Actions ---------- */
function startSearch(q){
  currentMode = 'search';
  currentQuery = q || inputEl.value.trim();
  currentPage = 1;
  currentMax = parseInt(selectMax.value) || 10;
  loadPage();
}

/* ---------- Event bindings ---------- */
btnSearch.addEventListener('click', ()=> startSearch(inputEl.value.trim()));
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter') startSearch(inputEl.value.trim()); });
btnHistory.addEventListener('click', ()=> showHistoryPrompt());
btnHome.addEventListener('click', ()=> { currentMode = 'home'; currentPage = 1; currentQuery = ''; inputEl.value = ''; loadLatest(); resultsEl.innerHTML = ''; pagerEl.innerHTML = ''; });
btnVerified.addEventListener('click', ()=> { currentMode = 'verified'; currentPage = 1; loadPage(); });
btnTrending.addEventListener('click', ()=> { currentMode = 'trending'; currentPage = 1; loadPage(); });
selectMax.addEventListener('change', ()=> { currentMax = parseInt(selectMax.value) || 10; currentPage = 1; if(currentMode !== 'home') loadPage(); });
btnClearCache.addEventListener('click', ()=> clearAllCache());

/* ---------- Init ---------- */
loadLatest();

// register service worker if available
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{/* ignore */});
}
</script>

</body>
</html>
