<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>t√¨m script c·ªßa t√¢m dz</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#0b1220,#0e1627);
  color:#e6eef8;
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:1000;
  background:rgba(15,23,42,0.9);
  backdrop-filter:blur(10px);
  padding:16px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:14px;
  border-bottom:1px solid #1f2a44;
}
.logo{
  font-size:22px;
  font-weight:700;
  background:linear-gradient(90deg,#38bdf8,#60a5fa);
  -webkit-background-clip:text;
  color:transparent;
}
.search-wrap{
  flex:1;
  display:flex;
  gap:10px;
}
.search-wrap input{
  flex:1;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #1f2a44;
  background:#0f1a28;
  color:white;
  font-size:15px;
  outline:none;
  transition:.2s;
}
.search-wrap input:focus{
  border-color:#38bdf8;
  box-shadow:0 0 10px #38bdf855;
}
.search-wrap button{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,#38bdf8,#0ea5e9);
  color:#04293a;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.search-wrap button:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 16px #38bdf855;
}

/* MAIN */
.container{
  max-width:1200px;
  margin:auto;
  padding:20px 14px 60px;
}

h2{
  margin:30px 0 14px;
  font-weight:600;
  color:#38bdf8;
  border-left:4px solid #38bdf8;
  padding-left:10px;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:18px;
}

/* CARD */
.card{
  background:#1e293b;
  border-radius:16px;
  overflow:hidden;
  cursor:pointer;
  transition:.25s;
  border:1px solid #1f2a44;
  position:relative;
}
.card:hover{
  transform:translateY(-8px);
  box-shadow:0 12px 30px #00000066;
}

/* THUMB */
.thumb{
  height:160px;
  background:#071826;
  overflow:hidden;
  position:relative;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition:transform .35s, opacity .25s;
  opacity:1;
}
.card:hover .thumb img{
  transform:scale(1.05);
}

/* CONTENT */
.content{
  padding:14px;
}
.title{
  font-size:15px;
  font-weight:600;
  margin-bottom:6px;
  min-height:40px;
}
.meta{
  font-size:13px;
  color:#94a3b8;
}

/* LOADER */
.loader{
  grid-column:1/-1;
  text-align:center;
  padding:30px;
  color:#94a3b8;
  font-size:14px;
}

/* SKELETON */
.skeleton {
  background: linear-gradient(90deg, #0f1720 0%, #121827 40%, #0f1720 100%);
  background-size: 200% 100%;
  animation: shimmer 1.1s linear infinite;
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.card.is-loading .thumb::after{
  content:'';
  display:block;
  width:100%;
  height:100%;
  position:absolute;
  left:0;top:0;
  background: linear-gradient(90deg,#0f1720 0%, #121827 40%, #0f1720 100%);
  background-size:200% 100%;
  animation: shimmer 1.1s linear infinite;
}
.card.is-loading .title,
.card.is-loading .meta {
  color: transparent;
}
.card.is-loading .title::after,
.card.is-loading .meta::after{
  content:'';
  display:block;
  height:14px;
  background:linear-gradient(90deg,#0f1720 0%, #121827 40%, #0f1720 100%);
  background-size:200% 100%;
  animation: shimmer 1.1s linear infinite;
  border-radius:6px;
  margin-top:6px;
}
.card.is-loading .title::after{ height:18px; width:80%; }
.card.is-loading .meta::after { height:12px; width:60%; margin-top:8px; }

/* MOBILE */
@media(max-width:600px){
  .thumb{height:130px}
  .logo{font-size:18px}
}

/* downloads button */
.downloads-btn{
  padding:12px 20px;
  border-radius:14px;
  text-decoration:none;
  font-weight:700;
  font-size:15px;
  letter-spacing:.5px;
  color:white;
  background:linear-gradient(135deg,#f59e0b,#ef4444);
  box-shadow:0 8px 22px rgba(239,68,68,.45);
  transition:.3s;
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
  border:1px solid #ffffff22;
}
.downloads-btn:hover{
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 12px 30px rgba(239,68,68,.6);
}
</style>
</head>

<body>

<header>
  <div class="logo">t√¨m script c·ªßa t√¢m dz</div>

  <div class="search-wrap">
    <input id="q" placeholder="T√¨m script (vd: blox fruit)..." />
    <button id="btnSearch">T√¨m</button>
  </div>

  <!-- N√öT SI√äU N·ªîI -->
  <a href="downloads.html" class="downloads-btn">
    üì¶ Kho t·∫£i file
  </a>
</header>

<div class="container">

  <h2>üîé K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
  <div id="results" class="grid"></div>

  <h2>üÜï Script m·ªõi nh·∫•t</h2>
  <div id="latest" class="grid"></div>

</div>

<script>
/* ---------- Config ---------- */
const API_BASE = 'https://scriptblox.com/api';
const SEARCH_ENDPOINT = API_BASE + '/script/search';
const SCRIPT_ENDPOINT = API_BASE + '/script'; // fetch details by id
const PLACEHOLDER = 'https://i.ibb.co/8gbRfFsp/images.png';
const MAX_PER_PAGE = 12;
const THUMB_NORMALIZE_BASE = 'https://scriptblox.com';

/* ---------- Utils ---------- */
const qs = sel => document.querySelector(sel);
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- DOM Refs ---------- */
const inputEl = qs('#q');
const btnSearch = qs('#btnSearch');
const resultsEl = qs('#results');
const latestEl = qs('#latest');

/* ---------- Cache for thumbs/details ---------- */
const thumbCache = new Map(); // id -> url or null
const detailCache = new Map(); // id -> full script detail

/* ---------- Normalize thumbnail URL ---------- */
function normalizeThumbUrl(raw){
  if(!raw) return null;
  raw = String(raw).trim();
  // if already absolute
  if(raw.startsWith('http://') || raw.startsWith('https://')) return raw;
  // protocol-less e.g. //scriptblox.com/...
  if(raw.startsWith('//')) return location.protocol + raw;
  // leading slash: /images/...
  if(raw.startsWith('/')) return THUMB_NORMALIZE_BASE + raw;
  // starts with images/ or images/script/...
  if(raw.startsWith('images/') || raw.startsWith('image/') || raw.startsWith('uploads/') || raw.startsWith('scripts/')) {
    return THUMB_NORMALIZE_BASE + '/' + raw;
  }
  // contains "scriptblox.com" but missing scheme
  if(raw.includes('scriptblox.com')) {
    return (raw.startsWith('http') ? raw : 'https://' + raw);
  }
  // fallback: prefix scriptblox
  return THUMB_NORMALIZE_BASE + '/' + raw;
}

/* ---------- Get thumbnail robustly (tries many fields, then details) ---------- */
async function getThumbUrl(scriptObj){
  if(!scriptObj) return PLACEHOLDER;
  const id = scriptObj._id || scriptObj.id || scriptObj._id_str || scriptObj.id_str || (scriptObj.slug ? 's-'+scriptObj.slug : null);

  if(id && thumbCache.has(id)) return thumbCache.get(id);

  const tryFields = ['image','thumbnail','imageUrl','thumb','thumbUrl','coverImage','preview','cover','img','url','imagePath','thumbnailUrl'];
  for(const f of tryFields){
    const v = scriptObj[f];
    if(v){
      const n = normalizeThumbUrl(v);
      thumbCache.set(id || f, n);
      return n;
    }
  }

  // nested game/owner fields
  if(scriptObj.game){
    const v = scriptObj.game.imageUrl || scriptObj.game.thumbnail || scriptObj.game.thumb || scriptObj.game.icon || scriptObj.game.image;
    if(v){
      const n = normalizeThumbUrl(v);
      if(id) thumbCache.set(id,n);
      return n;
    }
  }
  if(scriptObj.owner){
    const v = scriptObj.owner.avatar || scriptObj.owner.image || scriptObj.owner.avatarUrl;
    if(v){
      const n = normalizeThumbUrl(v);
      if(id) thumbCache.set(id,n);
      return n;
    }
  }

  // not found in summary -> fetch full detail and try again
  if(id){
    try{
      let full = detailCache.get(id);
      if(!full){
        const res = await fetch(`${SCRIPT_ENDPOINT}/${encodeURIComponent(id)}`);
        if(res.ok){
          const j = await res.json();
          full = j.script || j.result || j.data || j;
          detailCache.set(id, full);
        } else {
          // if detail endpoint returns a relative object (rare), still continue
        }
      }
      if(full){
        for(const f of tryFields){
          const v = full[f];
          if(v){
            const n = normalizeThumbUrl(v);
            thumbCache.set(id,n);
            return n;
          }
        }
        // nested arrays or properties
        if(full.game){
          const v = full.game.imageUrl || full.game.thumbnail || full.game.thumb;
          if(v){ const n=normalizeThumbUrl(v); thumbCache.set(id,n); return n; }
        }
        if(full.images && Array.isArray(full.images) && full.images.length){
          const n = normalizeThumbUrl(full.images[0]);
          thumbCache.set(id,n);
          return n;
        }
        if(full.assets && Array.isArray(full.assets) && full.assets.length){
          const a = full.assets[0];
          const v = (a && (a.url || a.path || a.src)) || a;
          if(v){ const n=normalizeThumbUrl(v); thumbCache.set(id,n); return n; }
        }
      }
    }catch(e){
      console.debug('detail fetch failed for', id, e);
    }
  }

  // final fallback
  if(id) thumbCache.set(id, PLACEHOLDER);
  return PLACEHOLDER;
}

/* ---------- Card HTML (initial skeleton) ---------- */
function createCardHTML(s){
  const id = escapeHtml(s._id || s.id || '');
  const title = escapeHtml(s.title || s.name || 'Untitled');
  const gameName = escapeHtml(s.game?.name || '-');
  const author = escapeHtml(s.owner?.username || s.owner?.name || '-');
  const views = escapeHtml(s.views || s.viewCount || 0);
  return `
    <div class="card is-loading" data-id="${id}">
      <div class="thumb"><img loading="lazy" src="${PLACEHOLDER}" alt="${title}"></div>
      <div class="content">
        <div class="title">${title}</div>
        <div class="meta">${gameName}</div>
        <div class="meta">T√°c gi·∫£: ${author} ¬∑ üëÅ ${views}</div>
      </div>
    </div>
  `;
}

/* ---------- Attach clicks ---------- */
function attachCardClicks(container){
  container.querySelectorAll('.card').forEach(card=>{
    card.onclick = ()=>{ const id = card.dataset.id; if(id) view(id); };
  });
}

/* ---------- Render list with progressive thumb load + timeout fallback ---------- */
async function renderScriptsList(scripts, container){
  if(!scripts || scripts.length === 0){
    container.innerHTML = '<div class="loader">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
    return;
  }

  // render skeleton cards first
  container.innerHTML = scripts.map(s => createCardHTML(s)).join('');
  attachCardClicks(container);

  const cards = Array.from(container.querySelectorAll('.card'));

  // for each script, load thumb
  await Promise.all(scripts.map(async (s, idx) => {
    const card = cards[idx];
    if(!card) return;
    const img = card.querySelector('img');

    // set timeout to remove skeleton if image never loads (e.g., CORS or 404)
    let timedOut = false;
    const t = setTimeout(()=>{
      timedOut = true;
      card.classList.remove('is-loading');
      img.src = PLACEHOLDER;
    }, 3500); // 3.5s timeout

    try{
      const urlRaw = await getThumbUrl(s);
      const url = normalizeThumbUrl(urlRaw || PLACEHOLDER);

      // set handlers
      const onLoad = () => {
        if(timedOut) return;
        clearTimeout(t);
        img.style.opacity = '1';
        card.classList.remove('is-loading');
        cleanup();
      };
      const onErr = () => {
        if(timedOut) return;
        clearTimeout(t);
        img.src = PLACEHOLDER;
        card.classList.remove('is-loading');
        cleanup();
      };
      function cleanup(){
        img.removeEventListener('load', onLoad);
        img.removeEventListener('error', onErr);
      }

      img.addEventListener('load', onLoad);
      img.addEventListener('error', onErr);

      // assign src (this triggers load/error)
      if(img.src !== url) img.src = url;
    }catch(e){
      clearTimeout(t);
      card.classList.remove('is-loading');
      img.src = PLACEHOLDER;
    }
  }));
}

/* ---------- API wrapper ---------- */
async function apiSearch(q, max = MAX_PER_PAGE){
  const qParam = q && q.trim() ? q.trim() : 'script';
  const url = `${SEARCH_ENDPOINT}?q=${encodeURIComponent(qParam)}&max=${max}`;
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const j = await res.json();
    return j.result?.scripts || j.scripts || j.data?.scripts || [];
  }catch(e){
    console.error('API search failed', e);
    return [];
  }
}

/* ---------- UI flows ---------- */
async function loadLatest(){
  latestEl.innerHTML = '<div class="loader">ƒêang t·∫£i script m·ªõi...</div>';
  const scripts = await apiSearch('script', 12);
  await renderScriptsList(scripts, latestEl);
}

async function startSearch(q){
  resultsEl.innerHTML = '<div class="loader">ƒêang t√¨m ki·∫øm...</div>';
  const scripts = await apiSearch(q, 12);
  await renderScriptsList(scripts, resultsEl);
}

/* ---------- Actions ---------- */
function view(id){
  // open view page
  window.location.href = `view.html?id=${encodeURIComponent(id)}`;
}

/* ---------- Events ---------- */
btnSearch.addEventListener('click', ()=> startSearch(inputEl.value.trim()));
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter') startSearch(inputEl.value.trim()); });

/* ---------- Init ---------- */
loadLatest();
</script>

</body>
</html>
