<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>t√¨m script c·ªßa t√¢m dz</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Poppins',sans-serif;
  background:linear-gradient(135deg,#0b1220,#0e1627);
  color:#e6eef8;
}

/* HEADER */
header{
  position:sticky;
  top:0;
  z-index:1000;
  background:rgba(15,23,42,0.9);
  backdrop-filter:blur(10px);
  padding:16px;
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:14px;
  border-bottom:1px solid #1f2a44;
}
.logo{
  font-size:22px;
  font-weight:700;
  background:linear-gradient(90deg,#38bdf8,#60a5fa);
  -webkit-background-clip:text;
  color:transparent;
}
.search-wrap{
  flex:1;
  display:flex;
  gap:10px;
}
.search-wrap input{
  flex:1;
  padding:12px 14px;
  border-radius:12px;
  border:1px solid #1f2a44;
  background:#0f1a28;
  color:white;
  font-size:15px;
  outline:none;
  transition:.2s;
}
.search-wrap input:focus{
  border-color:#38bdf8;
  box-shadow:0 0 10px #38bdf855;
}
.search-wrap button{
  padding:12px 18px;
  border-radius:12px;
  border:none;
  background:linear-gradient(90deg,#38bdf8,#0ea5e9);
  color:#04293a;
  font-weight:600;
  cursor:pointer;
  transition:.2s;
}
.search-wrap button:hover{
  transform:translateY(-2px);
  box-shadow:0 6px 16px #38bdf855;
}

/* MAIN */
.container{
  max-width:1200px;
  margin:auto;
  padding:20px 14px 60px;
}

h2{
  margin:30px 0 14px;
  font-weight:600;
  color:#38bdf8;
  border-left:4px solid #38bdf8;
  padding-left:10px;
}

/* GRID */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
  gap:18px;
}

/* CARD */
.card{
  background:#1e293b;
  border-radius:16px;
  overflow:hidden;
  cursor:pointer;
  transition:.25s;
  border:1px solid #1f2a44;
  position:relative;
}
.card:hover{
  transform:translateY(-8px);
  box-shadow:0 12px 30px #00000066;
}

/* THUMB */
.thumb{
  height:160px;
  background:#071826;
  overflow:hidden;
  position:relative;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
  transition:transform .35s, opacity .25s;
  opacity:1;
}
.card:hover .thumb img{
  transform:scale(1.05);
}

/* CONTENT */
.content{
  padding:14px;
}
.title{
  font-size:15px;
  font-weight:600;
  margin-bottom:6px;
  min-height:40px;
}
.meta{
  font-size:13px;
  color:#94a3b8;
}

/* LOADER */
.loader{
  grid-column:1/-1;
  text-align:center;
  padding:30px;
  color:#94a3b8;
  font-size:14px;
}

/* SKELETON */
.skeleton {
  background: linear-gradient(90deg, #0f1720 0%, #121827 40%, #0f1720 100%);
  background-size: 200% 100%;
  animation: shimmer 1.1s linear infinite;
}
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}
.card.is-loading .thumb::after{
  content:'';
  display:block;
  width:100%;
  height:100%;
  position:absolute;
  left:0;top:0;
  background: linear-gradient(90deg,#0f1720 0%, #121827 40%, #0f1720 100%);
  background-size:200% 100%;
  animation: shimmer 1.1s linear infinite;
}
.card.is-loading .title,
.card.is-loading .meta {
  color: transparent;
}
.card.is-loading .title::after,
.card.is-loading .meta::after{
  content:'';
  display:block;
  height:14px;
  background:linear-gradient(90deg,#0f1720 0%, #121827 40%, #0f1720 100%);
  background-size:200% 100%;
  animation: shimmer 1.1s linear infinite;
  border-radius:6px;
  margin-top:6px;
}
.card.is-loading .title::after{ height:18px; width:80%; }
.card.is-loading .meta::after { height:12px; width:60%; margin-top:8px; }

/* MOBILE */
@media(max-width:600px){
  .thumb{height:130px}
  .logo{font-size:18px}
}

/* downloads button */
.downloads-btn{
  padding:12px 20px;
  border-radius:14px;
  text-decoration:none;
  font-weight:700;
  font-size:15px;
  letter-spacing:.5px;
  color:white;
  background:linear-gradient(135deg,#f59e0b,#ef4444);
  box-shadow:0 8px 22px rgba(239,68,68,.45);
  transition:.3s;
  display:flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
  border:1px solid #ffffff22;
}
.downloads-btn:hover{
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 12px 30px rgba(239,68,68,.6);
}
</style>
</head>

<body>

<header>
  <div class="logo">t√¨m script c·ªßa t√¢m dz</div>

  <div class="search-wrap">
    <input id="q" placeholder="T√¨m script (vd: blox fruit)..." />
    <button id="btnSearch">T√¨m</button>
  </div>

  <!-- N√öT SI√äU N·ªîI -->
  <a href="downloads.html" class="downloads-btn">
    üì¶ Kho t·∫£i file
  </a>
</header>

<div class="container">

  <h2>üîé K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
  <div id="results" class="grid"></div>

  <h2>üÜï Script m·ªõi nh·∫•t</h2>
  <div id="latest" class="grid"></div>

</div>

<script>
/* ========== C·∫§U H√åNH CRAWL (thay API) ========== */
const SITE_BASE = 'https://scriptblox.com';
const PROXY = 'https://api.allorigins.win/raw?url='; // proxy ƒë·ªÉ tr√°nh CORS
const SCRIPT_PAGE_BASE = SITE_BASE + '/script';
const PLACEHOLDER = 'https://i.ibb.co/8gbRfFsp/images.png';
const MAX_PER_PAGE = 12;

/* ---------- Utils ---------- */
const qs = sel => document.querySelector(sel);
function escapeHtml(s){ if(s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
const inputEl = qs('#q');
const btnSearch = qs('#btnSearch');
const resultsEl = qs('#results');
const latestEl = qs('#latest');

/* ---------- Cache ---------- */
const thumbCache = new Map();
const detailCache = new Map();

/* ---------- Normalize thumbnail URL (keep your original logic) ---------- */
function normalizeThumbUrl(raw){
  if(!raw) return null;
  raw = String(raw).trim();
  if(raw.startsWith('http://') || raw.startsWith('https://')) return raw;
  if(raw.startsWith('//')) return location.protocol + raw;
  if(raw.startsWith('/')) return SITE_BASE + raw;
  if(raw.startsWith('images/') || raw.startsWith('image/') || raw.startsWith('uploads/') || raw.startsWith('scripts/')) {
    return SITE_BASE + '/' + raw;
  }
  if(raw.includes('scriptblox.com')) {
    return (raw.startsWith('http') ? raw : 'https://' + raw);
  }
  return SITE_BASE + '/' + raw;
}

/* ---------- Fetch HTML via proxy (allorigins) ---------- */
async function fetchHTML(url){
  try{
    const proxyUrl = PROXY + encodeURIComponent(url);
    const res = await fetch(proxyUrl);
    if(!res.ok) throw new Error('proxy fetch failed ' + res.status);
    return await res.text();
  }catch(e){
    console.error('fetchHTML error', e);
    return null;
  }
}

/* ---------- Crawl search results page and build script objects ---------- */
async function apiSearch(q, max = MAX_PER_PAGE){
  const keyword = q && q.trim() ? q.trim() : 'script';
  const searchUrl = `${SITE_BASE}/search?q=${encodeURIComponent(keyword)}`;
  try{
    const html = await fetchHTML(searchUrl);
    if(!html) return [];
    const doc = new DOMParser().parseFromString(html, 'text/html');

    // find anchors to script pages
    const anchors = [...doc.querySelectorAll("a[href^='/script/']")];

    // dedupe by href and keep first occurrences
    const seen = new Set();
    const items = [];
    for(const a of anchors){
      const href = a.getAttribute('href') || '';
      if(!href || seen.has(href)) continue;
      seen.add(href);

      // attempt to get title, image, game, author, views
      const title = a.querySelector('h3')?.innerText?.trim() || a.querySelector('.title')?.innerText?.trim() || (a.textContent||'').trim().split('\n')[0];
      const imgEl = a.querySelector('img');
      const imgRaw = imgEl ? (imgEl.getAttribute('src') || imgEl.getAttribute('data-src') || '') : '';
      const img = imgRaw ? normalizeThumbUrl(imgRaw) : '';

      const game = a.querySelector('.game')?.innerText || a.querySelector('p')?.innerText || '';
      const owner = a.querySelector('.owner')?.innerText || '';

      // id (use href tail)
      const id = href.replace(/^\/script\/+/, '').replace(/\/.*$/, '');

      items.push({
        _id: id,
        title: title || id,
        image: img || '',
        game: { name: game || '' },
        owner: { username: owner || '' },
        views: 0,
        href: href
      });

      if(items.length >= max) break;
    }

    return items;
  }catch(e){
    console.error('apiSearch crawl error', e);
    return [];
  }
}

/* ---------- If thumbnail not available in listing, crawl script detail page for image ---------- */
async function getThumbUrl(scriptObj){
  if(!scriptObj) return PLACEHOLDER;
  const id = scriptObj._id || scriptObj.id || (scriptObj.href ? scriptObj.href.replace(/^\/script\//,'') : null);
  if(!id) return PLACEHOLDER;
  if(thumbCache.has(id)) return thumbCache.get(id);

  // prefer image field if present
  const tryFields = ['image','thumbnail','imageUrl','thumb','thumbUrl','coverImage','preview','cover','img','url','imagePath','thumbnailUrl'];
  for(const f of tryFields){
    const v = scriptObj[f];
    if(v){
      const n = normalizeThumbUrl(v);
      thumbCache.set(id, n);
      return n;
    }
  }
  if(scriptObj.image){
    const n = normalizeThumbUrl(scriptObj.image);
    thumbCache.set(id,n);
    return n;
  }

  // try nested game/owner props
  if(scriptObj.game){
    const v = scriptObj.game.imageUrl || scriptObj.game.thumbnail || scriptObj.game.thumb || scriptObj.game.icon || scriptObj.game.image;
    if(v){ const n=normalizeThumbUrl(v); thumbCache.set(id,n); return n; }
  }
  if(scriptObj.owner){
    const v = scriptObj.owner.avatar || scriptObj.owner.image || scriptObj.owner.avatarUrl;
    if(v){ const n=normalizeThumbUrl(v); thumbCache.set(id,n); return n; }
  }

  // fetch script detail page HTML and try to extract images
  try{
    const detailUrl = `${SCRIPT_PAGE_BASE}/${encodeURIComponent(id)}`;
    const html = await fetchHTML(detailUrl);
    if(html){
      const doc = new DOMParser().parseFromString(html, 'text/html');

      // try common selectors in script detail pages
      // 1) first image in main content
      let img = doc.querySelector('main img')?.getAttribute('src') || doc.querySelector('.script-cover img')?.getAttribute('src') || '';
      if(!img){
        // fallback: any img containing 'script' or 'images'
        const imgs = [...doc.querySelectorAll('img')];
        const found = imgs.find(i => {
          const s = (i.getAttribute('src')||'').toLowerCase();
          return s.includes('/images/') || s.includes('/script/') || s.includes('thumbnail') || s.includes('cover');
        });
        if(found) img = found.getAttribute('src') || '';
      }
      if(img){
        const n = normalizeThumbUrl(img);
        thumbCache.set(id, n);
        return n;
      }
    }
  }catch(e){
    console.debug('detail page crawl failed for', id, e);
  }

  thumbCache.set(id, PLACEHOLDER);
  return PLACEHOLDER;
}

/* ---------- Card HTML ---------- */
function createCardHTML(s){
  const id = escapeHtml(s._id || s.id || s.href || '');
  const title = escapeHtml(s.title || s.name || 'Untitled');
  const gameName = escapeHtml(s.game?.name || '-');
  const author = escapeHtml(s.owner?.username || s.owner?.name || '-');
  const views = escapeHtml(s.views || s.viewCount || 0);
  return `
    <div class="card is-loading" data-id="${id}" data-href="${escapeHtml(s.href || '/script/' + (s._id||''))}">
      <div class="thumb"><img loading="lazy" src="${PLACEHOLDER}" alt="${title}"></div>
      <div class="content">
        <div class="title">${title}</div>
        <div class="meta">${gameName}</div>
        <div class="meta">T√°c gi·∫£: ${author} ¬∑ üëÅ ${views}</div>
      </div>
    </div>
  `;
}

/* ---------- Attach clicks ---------- */
function attachCardClicks(container){
  container.querySelectorAll('.card').forEach(card=>{
    card.onclick = ()=>{ 
      const href = card.getAttribute('data-href') || '';
      if(href.startsWith('http')) window.open(href,'_blank');
      else window.location.href = SITE_BASE + href;
    };
  });
}

/* ---------- Render list with progressive thumb load ---------- */
async function renderScriptsList(scripts, container){
  if(!scripts || scripts.length === 0){
    container.innerHTML = '<div class="loader">Kh√¥ng c√≥ d·ªØ li·ªáu</div>';
    return;
  }

  container.innerHTML = scripts.map(s => createCardHTML(s)).join('');
  attachCardClicks(container);

  const cards = Array.from(container.querySelectorAll('.card'));

  await Promise.all(scripts.map(async (s, idx) => {
    const card = cards[idx];
    if(!card) return;
    const img = card.querySelector('img');

    let timedOut = false;
    const t = setTimeout(()=>{
      timedOut = true;
      card.classList.remove('is-loading');
      img.src = PLACEHOLDER;
    }, 3500);

    try{
      const urlRaw = await getThumbUrl(s);
      const url = normalizeThumbUrl(urlRaw || PLACEHOLDER);

      const onLoad = () => {
        if(timedOut) return;
        clearTimeout(t);
        img.style.opacity = '1';
        card.classList.remove('is-loading');
        cleanup();
      };
      const onErr = () => {
        if(timedOut) return;
        clearTimeout(t);
        img.src = PLACEHOLDER;
        card.classList.remove('is-loading');
        cleanup();
      };
      function cleanup(){
        img.removeEventListener('load', onLoad);
        img.removeEventListener('error', onErr);
      }

      img.addEventListener('load', onLoad);
      img.addEventListener('error', onErr);

      if(img.src !== url) img.src = url;
    }catch(e){
      clearTimeout(t);
      card.classList.remove('is-loading');
      img.src = PLACEHOLDER;
    }
  }));
}

/* ---------- UI flows ---------- */
async function loadLatest(){
  latestEl.innerHTML = '<div class="loader">ƒêang t·∫£i script m·ªõi...</div>';
  const scripts = await apiSearch('script', MAX_PER_PAGE);
  await renderScriptsList(scripts, latestEl);
}

async function startSearch(q){
  resultsEl.innerHTML = '<div class="loader">ƒêang t√¨m ki·∫øm...</div>';
  const scripts = await apiSearch(q, MAX_PER_PAGE);
  await renderScriptsList(scripts, resultsEl);
}

/* ---------- Events ---------- */
btnSearch.addEventListener('click', ()=> startSearch(inputEl.value.trim()));
inputEl.addEventListener('keydown', e => { if(e.key === 'Enter') startSearch(inputEl.value.trim()); });

/* ---------- Init ---------- */
loadLatest();
</script>

</body>
</html>
